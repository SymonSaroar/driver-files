<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
 <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110109-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-110109-1');
</script>
<script type="text/javascript" src="../common/version.js"></script>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="description" content="Chapter 15: Distributing Your Driver"/>
<title>Jungo WinDriver: Chapter 15: Distributing Your Driver</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-main.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="wd_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Jungo WinDriver
   &#160;
   <span id="projectnumber"></span>
   </div>
   <div id="projectbrief">Official Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('ch15_distributing_your_driver.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Chapter 15: Distributing Your Driver </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_chap15"></a>Read this chapter in the final stages of driver development. It will guide you in preparing your driver for distribution.</p>
<p >The recommmended way to build and pack a WinDriver based driver today is using our CMake+CPack packaging methods as described in <a class="el" href="ch15_distributing_your_driver.html#ch15_2_4_redistribute_your_windriver-based_package_as_a_self-extracting_exe">15.2.4. Redistribute Your WinDriver-based package as a self-extracting EXE</a> and <a class="el" href="ch15_distributing_your_driver.html#ch15_3_5_redistribute_your_windriver-based_package_as_a_self-extracting_sh_stgz">15.3.5. Redistribute Your WinDriver-based package as a self-extracting SH (STGZ)</a> (depending on your operating system) as this method automates many steps in the redistribution process. If you wish to manually create the distribution package, follow <a class="el" href="ch15_distributing_your_driver.html#ch15_2_windows_driver_distribution">15.2. Windows Driver Distribution</a> or <a class="el" href="ch15_distributing_your_driver.html#ch15_3_linux_driver_distribution">15.3. Linux Driver Distribution</a>.</p>
<h1><a class="anchor" id="ch15_1_getting_a_valid_windriver_license"></a>
15.1. Getting a Valid WinDriver License</h1>
<p >Before distributing your driver you must purchase a WinDriver license.</p>
<p >Then install the registered version of WinDriver on your development machine by following the installation instructions. If you have already installed an evaluation version of WinDriver, you can jump directly to the installation steps for registered users to activate your license.</p>
<blockquote class="doxtable">
<p >&zwj;<b>ℹ️ Note</b></p>
<blockquote class="doxtable">
<p >&zwj;If you wish to distribute the developed driver with your own driver development kit providing your customers with APIs, or if your driver will eventually be part of a development product or environment, please send an e-mail to <a href="#" onclick="location.href='mai'+'lto:'+'sal'+'es'+'@ju'+'ng'+'o.c'+'om'; return false;">sales<span class="obfuscator">.nosp@m.</span>@jun<span class="obfuscator">.nosp@m.</span>go.co<span class="obfuscator">.nosp@m.</span>m</a> so our team could give you some additional information which concerns such destribution method. <br  />
 </p>
</blockquote>
</blockquote>
<h1><a class="anchor" id="ch15_2_windows_driver_distribution"></a>
15.2. Windows Driver Distribution</h1>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;All references to wdreg in this section can be replaced with wdreg_gui, which offers the same functionality as wdreg but displays GUI messages instead of console-mode messages. </p>
</blockquote>
</blockquote>
<p>If you have renamed the WinDriver kernel module (<code>windrvr1511.sys</code>), replace the relevant <code>windrvr1511</code> references with the name of your driver, and replace references to the <code>WinDriver\redist</code> directory with the path to the directory that contains your modified installation files.</p>
<p >For example, when using the generated DriverWizard renamed driver files for your driver project, you can replace references to the <code>WinDriver\redist</code> directory with references to the generated <code>xxx_installation\redist</code> directory (where xxx is the name of your generated driver project).</p>
<p >Note also the option to simplify the installation using the generated DriverWizard <code>xxx_install.bat</code> script and the copies of the <code>WinDriver\util</code> installation files in the generated <code>xxx_installation\redist</code> directory.</p>
<p >If you have created new INF and/or catalog files for your driver, replace the references to the original WinDriver INF files and/or to the <code>windrvr1511.cat</code> catalog file with the names of your new files.</p>
<p >Distributing the driver you created is a multi-step process.</p>
<p ><b>First</b>, create a distribution package that includes all the files required for the installation of the driver on the target computer.</p>
<p ><b>Second</b>, install the driver on the target machine. This involves installing <code>windrvr1511.sys</code> and <code>windrvr1511.inf</code>, installing the specific INF file for your device, and installing your Kernel PlugIn driver (if you have created one).</p>
<p ><b>Finally</b>, you need to install and execute the hardware-control application that you developed with WinDriver. These steps can be performed using wdreg utility.</p>
<p >It is also important to mention that all OS references in this document are applicable only to WinDriver versions that officially support these operating systems.</p>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;The windrvr&lt;version&gt;.sys, windrvr&lt;version&gt;.inf, and windrvr&lt;version&gt;.cat files, mentioned in this chapter, can be found in the <code>WinDriver\redist</code> directory on the development PC. <code>wdreg.exe</code> / <code>wdreg_gui.exe</code> and <code>difxapi.dll</code> can be found in the <code>WinDriver\util</code> directory. The source code of the wdreg utility is found in the <code>WinDriver\samples\c\wdreg</code> directory. </p>
</blockquote>
</blockquote>
<h2><a class="anchor" id="ch15_2_1_preparing_the_distribution_package_windows"></a>
15.2.1. Preparing the Distribution Package</h2>
<p >Prepare a distribution package that includes the following files.</p>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;If you wish to distribute drivers for both 32-bit and 64-bit target platforms, you must prepare separate distribution packages for each platform. The required files for each package are provided in the WinDriver installation directory for the respective platform. </p>
</blockquote>
</blockquote>
<ul>
<li>Your hardware-control application/DLL.</li>
<li><code>windrvr1511.sys</code>. Get this file from the <code>WinDriver\redist</code> directory of the WinDriver package.</li>
<li><code>windrvr1511.inf</code>. Get this file from the <code>WinDriver\redist</code> directory of the WinDriver package.</li>
<li><code>windrvr1511.cat</code> Get this file from the <code>WinDriver\redist</code> directory of the WinDriver package.</li>
<li><code>wdapi1511.dll</code> (for distribution of 32-bit binaries to 32-bit target platforms or for distribution of 64-bit binaries to 64-bit platforms) or <code>wdapi1511_32.dll</code> (for distribution of 32-bit binaries to 64-bit platforms. Get this file from the <code>WinDriver\redist</code> directory of the WinDriver package.</li>
<li>If your user application is a C#.NET/VB.NET application/DLL you must also add <code>wdapi_dotnet1511.dll</code> (for distribution of 32-bit binaries to 32-bit target platforms or for distribution of 64-bit binaries to 64-bit platforms) or <code>wdapi_dotnet1511_32.dll</code> (for distribution of 32-bit binaries to 64-bit platforms. Get this file from the <code>WinDriver\lib</code> directory of the WinDriver package, or from the Visual Studio project's Release directory.</li>
<li>If your user application is a Java application/DLL you must also add <code>wdapi_java1511.dll</code> (for distribution of 32-bit binaries to 32-bit target platforms or for distribution of 64-bit binaries to 64-bit platforms). You should also add <code>wdapi_java1511.jar</code> to your package. Get those files from the <code>WinDriver\lib</code> directory of the WinDriver package (specifically from its subdirectory relevant to your platform).</li>
<li><code>difxapi.dll</code> (required by the <code>wdreg.exe</code> utility). Get this file from the <code>WinDriver\util</code> directory of the WinDriver package.</li>
<li>An INF file for your device. You can generate this file with DriverWizard.</li>
<li>If you have created a Kernel PlugIn driver: Your Kernel PlugIn driver — <code>&lt;KP driver name&gt;.sys</code>.</li>
</ul>
<h2><a class="anchor" id="ch15_2_2_installing_your_driver_on_the_target_computer"></a>
15.2.2. Installing Your Driver on the Target Computer</h2>
<p >Driver installation on Windows requires administrator privileges.</p>
<p >Follow the instructions below in the order specified to properly install your driver on the target computer:</p>
<p ><b>Preliminary Steps</b>:</p>
<p >To successfully install your driver, make sure that there are no open handles to the WinDriver service (<code>windrvr1511.sys</code> or your renamed driver), and that there are no connected and enabled Plug-and-Play devices that are registered with this service. If the service is being used, attempts to install the new driver using wdreg will fail. This is relevant, for example, when upgrading from an earlier version of the driver that uses the same driver name. You can disable or uninstall connected devices from the Device Manager (<b>Properties</b> | <b>Disable/Uninstall</b>) or using <code>wdreg</code>, or otherwise physically disconnect the device(s) from the PC.</p>
<p >This includes closing any applications that may be using the driver, uninstalling your old Kernel PlugIndriver (if you had created such a driver) and either disabling, uninstalling, or physically disconnecting any device that is registered to work with the WinDriver service:</p>
<div class="fragment"><div class="line">wdreg -name OLD_KP uninstall</div>
</div><!-- fragment --><blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;Since version 11.9.0 of WinDriver, the default driver module name includes the WinDriver version, so if you do not rename the driver to a previously-used name there should not be conflicts with older drivers. </p>
</blockquote>
</blockquote>
<p><b>Install WinDriver's kernel module</b>:</p>
<ul>
<li>Copy <code>windrvr1511.sys</code>, <code>windrvr1511.inf</code>, and <code>windrvr1511.cat</code> to the same directory.</li>
</ul>
<p ><code>windrvr1511.cat</code> contains the driver's Authenticode digital signature. To maintain the signature's validity this file must be found in the same installation directory as the <code>windrvr1511.inf</code> file. If you select to distribute the catalog and INF files in different directories, or make any changes to these files or to any other files referred to by the catalog file (such as <code>windrvr1511.sys</code>), you will need to do either of the following:</p>
<ul>
<li>Create a new catalog file and re-sign the driver using this file.</li>
<li>Comment-out or remove the following line in the <code>windrvr1511.inf</code> file:</li>
</ul>
<div class="fragment"><div class="line">CatalogFile=windrvr1511.cat</div>
</div><!-- fragment --><p >and do not include the catalog file in your driver distribution. However, note that this option invalidates the driver's digital signature.</p>
<ul>
<li>Use the utility <code>wdreg.exe</code> to install WinDriver's kernel module on the target computer:</li>
</ul>
<div class="fragment"><div class="line">wdreg -inf &lt;path to windrvr1511.inf&gt; install</div>
</div><!-- fragment --><p >For example, if <code>windrvr1511.inf</code> and <code>windrvr1511.sys</code> are in the <code>d:\MyDevice</code> directory on the target computer, the command should be:</p>
<div class="fragment"><div class="line">wdreg -inf d:\MyDevice\windrvr1511.inf install</div>
</div><!-- fragment --><p >You can find the executable of wdreg in the WinDriver package under the <code>WinDriver\util</code> directory:</p>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;<code>wdreg</code> is dependent on <code>devcon.exe</code>. <code>wdreg</code> is an interactive utility. If it fails, it will display a message instructing the user how to overcome the problem. In some cases the user may be asked to reboot the computer. </p>
</blockquote>
</blockquote>
<p>When distributing your driver, you should attempt to ensure that the installation does not overwrite a newer version of <code>windrvr1511.sys</code> with an older version of the file in Windows drivers directory <code>(windir%\system32\drivers)</code>. For example, by configuring your installation program (if you are using one) or your INF file so that the installer automatically compares the time stamp on these two files and does not overwrite a newer version with an older one. The provided <code>windrvr1511.inf</code> file uses the <code>COPYFLG_NO_VERSION_DIALOG</code> directive, which is designed to avoid overwriting a file in the destination directory with the source file if the existing file is newer than the source file. There is also a similar <code>COPYFLG_OVERWRITE_OLDER_ONLY_INF</code> directive that is designed to ensure that the source file is copied to the destination directory only if the destination file is superseded by a newer version. Note, however, that both of these INF directives are irrelevant to digitally signed drivers. As explained in the Microsoft INF CopyFiles Directive documentation — <a href="https://msdn.microsoft.com/en-us/library/ff546346%28v=vs.85%29.aspx">https://msdn.microsoft.com/en-us/library/ff546346%28v=vs.85%29.aspx</a> — if a driver package is digitally signed, Windows installs the package as a whole and does not selectively omit files in the package based on other versions already present on the computer.</p>
<p >The <code>windrvr1511.sys</code> driver provided by Jungo is digitally signed.</p>
<ul>
<li>Install the INF file for your device (registering your Plug-and-Play device with <code>windrvr1511.sys</code>):</li>
</ul>
<p >Run the utility wdreg with the install command to automatically install the INF file and update Windows Device Manager:</p>
<div class="fragment"><div class="line">wdreg -inf &lt;path to your INF file&gt; install</div>
</div><!-- fragment --><p >You can also use the wdreg utility's preinstall command to pre-install an INF file for a device that is not currently connected to the PC:</p>
<div class="fragment"><div class="line">wdreg -inf &lt;path to your INF file&gt; preinstall</div>
</div><!-- fragment --><p >If the installation fails with an <code>ERROR_FILE_NOT_FOUND</code> error, inspect the Windows registry to see if the RunOnce key exists in <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion</code>. This registry key is required by Windows Plug-and-Play in order to properly install drivers using INF files. If the RunOnce key is missing, create it; then try installing the INF file again.</p>
<ul>
<li>Install your Kernel PlugIn driver (if you created one).</li>
<li>Install <code>wdapi1511.dll</code>:</li>
</ul>
<p >If your hardware-control application/DLL uses <code>wdapi1511.dll</code> (as is the case for the sample and generated DriverWizard WinDriver projects), copy this DLL to the target's <code>windir%\system32</code> directory.</p>
<p >When distributing 32-bit applications/DLLs to 32-bit targets OR when distributing 64-bit applications/DLLs to 64-bit targets, copy <code>WinDriver\redist\wdapi&lt;version&gt;.dll</code> (e.g. <code>wdapi900.dll</code>) to the target’s <code>windir%\system32</code> directory.</p>
<p >If you are distributing a 32-bit application/DLL to a target 64-bit platform, rename <code>wdapi1511_32.dll</code> in your distribution package to <code>wdapi1511.dll</code>, and copy the renamed file to the target's <code>windir%\sysWOW64</code> directory.</p>
<p >If you attempt to write a 32-bit installation program that installs a 64-bit program, and therefore copies the 64-bit <code>wdapi1511.dll</code> DLL to the <code>windir%\system32</code> directory, you may find that the file is actually copied to the 32-bit <code>windir%\sysWOW64</code> directory. The reason for this is that Windows x64 platforms translate references to 64-bit directories from 32-bit commands into references to 32-bit directories. You can avoid the problem by using 64-bit commands to perform the necessary installation steps from your 32-bit installation program. The <code>system64.exe</code> program, provided in the <code>WinDriver\redist</code> directory of the Windows x64 WinDriver distributions, enables you to do this.</p>
<ul>
<li>Install your hardware-control application/DLL:</li>
</ul>
<p >Copy your hardware-control application / DLL to the target and run it!</p>
<h2><a class="anchor" id="ch15_2_3_installing_your_kernel_plugin_on_the_target_computer"></a>
15.2.3. Installing Your Kernel PlugIn on the Target Computer</h2>
<p >Driver installation on Windows requires administrator privileges.</p>
<p >If you have created a Kernel PlugIn driver, follow the additional instructions below:</p>
<ul>
<li>Copy your Kernel PlugIn driver (<code>&lt;KP driver name&gt;.sys</code>) to Windows drivers directory on the target computer (<code>windir%\system32\drivers</code>).</li>
<li>Use the utility <code>wdreg.exe</code> to add your Kernel PlugIn driver to the list of device drivers Windows loads on boot. Use the following installation command to install a SYS Kernel PlugIn Driver:</li>
</ul>
<div class="fragment"><div class="line">wdreg -name &lt;Your driver name, without the *.sys extension&gt; install</div>
</div><!-- fragment --><p >You can find the executable of wdreg in the WinDriver package under the <code>WinDriver\util</code> directory.</p>
<h2><a class="anchor" id="ch15_2_4_redistribute_your_windriver-based_package_as_a_self-extracting_exe"></a>
15.2.4. Redistribute Your WinDriver-based package as a self-extracting EXE</h2>
<p >Starting from WinDriver version 14.3, WinDriver supports creation of NSIS installers for Windows for your generated code and user applications, via a CMake Project compiled on Visual Studio 2019. Currently this feature is supported only on Windows 64 bit applications without a Kernel PlugIn.</p>
<h3><a class="anchor" id="ch15_2_4_1_the_installer_windows"></a>
15.2.4.1. The Installer</h3>
<p >What the Installer does:</p>
<ul>
<li>Packs your driver and your user application into a single self-extracting EXE file.</li>
<li>Installs the user application files to the target computer.</li>
<li>Installs WinDriver to the target computer using the <code>wdreg</code> utility.</li>
<li>Provides the user with an uninstall EXE file that removes the user application and the driver from the target computer.</li>
</ul>
<p >This allows to save users precious time in manually creating a redistribution package.</p>
<h3><a class="anchor" id="ch15_2_4_2_requirements_windows"></a>
15.2.4.2. Requirements</h3>
<p >Make sure Visual Studio 2019 is installed along with the “C++ CMake Tools for Windows” and “Desktop development with C++” components installed.</p>
<p >As the next step, please make sure NSIS is installed if you haven’t already installed it on your development machine. If it is not, you can download it from the NSIS website. Make sure that the PATH environment variable includes the path to makensis.exe. This can be done the following way:</p>
<ul>
<li>In the Start Menu type <code>Edit the system environment variables</code>, this will open the <code>System Properties</code> Window.</li>
<li>Click the <b>Environment Variables…</b> button.</li>
<li>Edit the <code>Path</code> Variable and make sure it includes the path to <code>MakeNSIS.exe</code> (e.g. <code>C:\Program Files\NSIS</code>)</li>
</ul>
<p ><b>Editing Environment Variables</b></p>
<div class="image">
<img src="cmake3.png" alt=""/>
</div>
 <h3><a class="anchor" id="ch15_2_4_3_instructions_windows"></a>
15.2.4.3. Instructions</h3>
<p >Follow these steps:</p>
<ul>
<li>From the DriverWizard code generation window – check the CMake Makefile (With NSIS Installer Generator) Checkbox.</li>
</ul>
<p ><b>WinDriver Code Generation Window</b></p>
<div class="image">
<img src="cmake4.png" alt=""/>
</div>
 <ul>
<li>In your generated code directory for your driver (<code>xxx</code> will be the driver name in this tutorial) found in <code>WinDriver\wizard\my_projects\xxx</code> you should find a <code>CMakeLists.txt</code> file.</li>
<li>Open Visual Studio 2019.</li>
<li>Go to <b>File</b> | <b>Open</b> | <b>CMake</b> and choose <code>WinDriver\wizard\my_projects\xxx\CMakeLists.txt</code>.</li>
<li>After all background tasks are complete you will be able to change Solution Explorer to the CMake Targets View from the Switch Views icon in the Solution Explorer.</li>
</ul>
<p ><b>Changing to CMake Targets View</b></p>
<div class="image">
<img src="cmake5.png" alt=""/>
</div>
 <p ><b>The CMake Targets View</b></p>
<div class="image">
<img src="cmake6.png" alt=""/>
</div>
 <ul>
<li>In order to start preparing your distribution package – you must compile it in Release configuration.</li>
<li>In order to redistribute your driver – edit <code>xxx_lib.c</code> such that <code>XXX_DEFAULT_LICENSE_STRING</code> will be defined to be your license string, and that <code>XXX_DEFAULT_DRIVER_NAME</code> will be defined to be your renamed driver name (in this case <code>xxx</code>). If you do not perform this step your user application might work on your development computer but will not work on the target computer.</li>
</ul>
<p ><b>License String replacement in code</b></p>
<div class="image">
<img src="cmake9.png" alt=""/>
</div>
 <ul>
<li>Build the project by right clicking <b>xxx Project</b> | <b>Build All</b> from the Solution Explorer. You should find a compiled <code>xxx.exe</code> file of your generated code in <br  />
 <code>WinDriver\wizard\my_projects\xxx\out\build\(PLATFORM_NAME)\WIN32</code> and an additional installer EXE file <code>xxx_1.0.0-win64.exe</code> <br  />
 in <code>WinDriver\wizard\my_projects\xxx\out\build\(PLATFORM_NAME)</code>. <br  />
 Jungo recommends using the installer EXE file for distributing your driver package.</li>
<li>Feel free to modify the <code>CMakeLists.txt</code> file to better suit for your needs.</li>
</ul>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;Before installing the driver on a Windows-based target machine, either digitally sign the driver or disable Digital Signature enforcement. In addition, make sure to run the installer EXE as Administrator to make sure it has privileges to install drivers. Failure to do so might result in the driver not being installed properly on the target machine. </p>
</blockquote>
</blockquote>
<h1><a class="anchor" id="ch15_3_linux_driver_distribution"></a>
15.3. Linux Driver Distribution</h1>
<p >To distribute your driver, prepare a distribution package containing the required files and then build and install the required driver components on the target.</p>
<p >If you have renamed the WinDriver driver module, replace references to <code>windrvr1511</code> in the following instructions with the name of your renamed driver module.</p>
<p >It is recommended that you supply an installation shell script to automate the build and installation processes on the target.</p>
<h2><a class="anchor" id="ch15_3_1_preparing_the_distribution_package_linux"></a>
15.3.1. Preparing the Distribution Package</h2>
<p >Prepare a distribution package containing the required files, as described in this section.</p>
<p >If you wish to distribute drivers for both 32-bit and 64-bit target platforms, you must prepare separate distribution packages for each platform. The required files for each package are provided in the WinDriver installation directory for the respective platform.</p>
<p >In the following instructions, <code>&lt;source_dir&gt;</code> represents the source directory from which to copy the distribution files. The default source directory is your WinDriver installation directory. However, if you have renamed the WinDriver driver module, the source directory is a directory containing modified files for compiling and installing the renamed drivers. When using DriverWizard to generate the driver code, the source directory for the renamed driver is the generated xxx_installation directory, where <code>xxx</code> is the name of your generated driver project.</p>
<h3><a class="anchor" id="ch15_3_1_1_kernel_module_components"></a>
15.3.1.1. Kernel Module Components</h3>
<p >Your WinDriver-based driver relies on the <code>windrvr1511.o/.ko</code> kernel driver module, which implements the WinDriver API — <code>windrvr1511.o/.ko</code>. In addition, if you have created a Kernel PlugIn driver, the functionality of this driver is implemented in a <code>kp_xxx_module.o/.ko</code> kernel driver module (where <code>xxx</code> is your selected driver project name).</p>
<p >Your kernel driver modules cannot be distributed as-is; they must be recompiled on each target machine, to match the kernel version on the target. This is due to the following reason: the Linux kernel is continuously under development, and kernel data structures are subject to frequent changes. To support such a dynamic development environment, and still have kernel stability, the Linux kernel developers decided that kernel modules must be compiled with header files identical to those with which the kernel itself was compiled. They enforce this by including a version number in the kernel header files, which is checked against the version number encoded into the kernel. This forces Linux driver developers to support recompilation of their driver with the target system's kernel version.</p>
<p >Following is a list of the components you need to distribute to enable compilation of your kernel driver modules on the target machine.</p>
<p >It is recommended that you copy the files to subdirectories in the distribution directory that match the source subdirectories, such as redist and include, except where otherwise specified. If you select not do so, you will need to modify the file paths in the configuration scripts and related makefile templates, to match the location of the files in your distribution directory.</p>
<ul>
<li>From the <code>&lt;source_dir&gt;/include</code> directory, copy <code><a class="el" href="windrvr_8h.html">windrvr.h</a></code>, <code><a class="el" href="wd__ver_8h.html">wd_ver.h</a></code>, and <code><a class="el" href="windrvr__usb_8h.html">windrvr_usb.h</a></code> — header files required for building the kernel modules on the target.</li>
</ul>
<p >Note that <code><a class="el" href="windrvr__usb_8h.html">windrvr_usb.h</a></code> is required also for non-USB drivers.</p>
<ul>
<li>From the <code>&lt;WinDriver installation directory&gt;/util</code> directory (or from the generated DriverWizard <code>xxx_installation/redist</code> directory), copy wdreg — a script for loading the WinDriver kernel driver module — to the redist distribution directory.</li>
<li>From the <code>&lt;source_dir&gt;/redist</code> directory, unless where otherwise specified, copy the following files:<ul>
<li><code>setup_inst_dir</code> — a script for installing the WinDriver driver module, using wdreg (see above).</li>
<li><code>linux_wrappers.c/.h</code> — wrapper library source code files that bind the kernel module to the Linux kernel.</li>
<li><code>linux_common.h</code> and <code>wdusb_interface.h</code> — header files required for building the kernel modules on the target.</li>
<li><code>wdusb_linux.c</code> — source file used by WinDriver to utilize the USB stack (for USB drivers).</li>
</ul>
</li>
</ul>
<p >Note that <code>wdusb_interface.h</code> is required also for non-USB drivers.</p>
<p >The compiled object code for building the WinDriver kernel driver module:</p>
<ul>
<li><code>windrvr_gcc_v3.o_shipped</code> — for GCC v3.x.x compilation (also have been tested to work with GCC up to version 8, for 64-bit versions of Linux)</li>
<li><code>windrvr_gcc_v3_regparm.o_shipped</code> — for GCC v3.x.x compilation (for 32-bit versions of Linux)</li>
</ul>
<p >Configuration scripts and makefile templates for creating makefiles for building and installing the WinDriver kernel driver module.</p>
<p >Files that include <code>.kbuild</code> in their names use kbuild for the driver compilation.</p>
<ul>
<li><code>configure</code> — a configuration script that uses the <code>makefile.in</code> template to create a makefile for building and installing the WinDriver driver module, and executes the configure.wd script (see below).</li>
<li><code>configure.wd</code> — a configuration script that uses the <code>makefile.wd[.kbuild].in</code> template to create a <code>makefile.wd[.kbuild]</code> makefile for building the <code>windrvr1511.o/.ko</code> driver module.</li>
<li><code>configure.usb</code> — a configuration script that uses the makefile.usb[.kbuild].in template to create a makefile.usb[.kbuild] makefile for building the <code>windrvr1511_usb.o/.ko</code> drive rmodule (for USB drivers).</li>
<li><code>makefile.in</code> — a template for the main makefile for building and installing the WinDriver kernel driver module, using <code>makefile.wd[.kbuild]</code> ( and <code>makefile.usb[.kbuild]</code>).</li>
<li><code>makefile.wd.in</code> and <code>makefile.wd.kdbuild.in</code> — templates for creating <code>makefile.wd[.kbuild]</code> makefiles for building and installing the <code>windrvr1511.o/.ko</code> driver module.</li>
<li><code>makefile.usb.in</code> and <code>makefile.usb.kdbuild.in</code> — templates for creating <code>makefile.usb[.kbuild]</code> makefiles for building and installing the <code>windrvr1511_usb.o/.ko</code> driver module.</li>
</ul>
<p >If you have created a Kernel PlugIn driver — copy the following files as well:</p>
<ul>
<li>From the generated DriverWizard <code>xxx_installation/redist</code> directory (where <code>xxx</code> is the name of your driver project), copy the following configuration script and makefile templates, for creating a makefile for building and installing the Kernel PlugIn driver.</li>
</ul>
<p >If you did not generate your Kernel PlugIn driver using the DriverWizard, copy the files from your Kernel PlugIn project; the files for the KP_PCI sample, for example, are found in the <code>WinDriver/samples/c/pci_diag/kp_pci</code> directory.</p>
<p >Note: before copying the files, rename them to add a ".kp" indication — as in the <code>xxx_installation/redist</code> file names listed below — in order to distinguish them from the WinDriver driver module files. You will also need to edit the file names and paths in the files, to match the structure of the distribution directory.</p>
<ul>
<li><code>configure.kp</code> — a configuration script that uses the <code>makefile.kp[.kbuild].in</code> template (see below) to create a makefile.kp makefile for building and installing the Kernel PlugIn driver module.</li>
</ul>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;If you have renamed the WinDriver kernel module, be sure to uncomment the following line in your Kernel PlugIn configuration script (by removing the pound sign — "#"), before executing the script, in order to build the driver with the <code>-DWD_DRIVER_NAME_CHANGE</code> flag: <code># ADDITIONAL_FLAGS="-DWD_DRIVER_NAME_CHANGE"</code> </p>
</blockquote>
</blockquote>
<ul>
<li>makefile.kp.in and makefile.kp.kbuild.in — templates for creating a makefile.kp makefile for building and installing the Kernel PlugIn driver module. The makefile created from makefile.kp.build.in uses kbuild for the compilation.</li>
</ul>
<p >From the <code>&lt;source_dir&gt;/lib</code> directory, copy the compiled WinDriver-API object code:</p>
<ul>
<li><code>kp_wdapi1511_gcc_v3.o_shipped</code> — for GCC v3.x.x compilation (also been tested to work with GCC up to version 5.4.0).</li>
<li><code>kp_wdapi1511_gcc_v3_regparm.o_shipped</code> — for GCC v3.x.x compilation with the regparm flag.</li>
</ul>
<p >From the <code>kermode/linux/LINUX.&lt;kernel version&gt;.&lt;CPU&gt;</code> directory that is created when building the Kernel PlugIn driver on the development machine, copy to the lib distribution subdirectory the compiled object code for building your Kernel PlugIn driver module (where xxx is the name of your Kernel PlugIn driver project):</p>
<ul>
<li><code>kp_xxx_gcc_v3.o_shipped</code> — for GCC v3.x.x compilation (also have been tested to work on GCC versions up to 8, for 64-bit versions of Linux).</li>
<li><code>kp_xxx_gcc_v3_regparm.o_shipped</code> — for GCC v3.x.x compilation (for 32-bit versions of Linux).</li>
</ul>
<h3><a class="anchor" id="ch15_3_1_2_user-mode_hardware-control_application_or_shared_object"></a>
15.3.1.2. User-Mode Hardware-Control Application or Shared Object</h3>
<p >Copy the user-mode hardware-control application or shared object that you created with WinDriver, to the distribution package.</p>
<p >If your hardware-control application/shared object uses <code>libwdapi1511.so</code> — as is the case for the WinDriver samples and generated DriverWizard projects — copy this file from the <code>&lt;source_dir&gt;/lib</code> directory to your distribution package.</p>
<p >If you are distributing a 32-bit application/shared object to a target 64-bit platform — copy <code>libwdapi1511_32.so</code> from the <code>WinDriver/lib</code> directory to your distribution package, and rename the copy to <code>libwdapi1511.so</code>.</p>
<p >If your user application is a Java application/shared object you must also add <code>libwdapi_java1511.so</code> (for distribution of 32-bit binaries to 32-bit target platforms or for distribution of 64-bit binaries to 64-bit platforms). You should also add <code>wdapi_java1511.jar</code> to your package. Get those files from the <code>WinDriver\lib</code> directory of the WinDriver package (specifically from its subdirectory relevant to your platform).</p>
<p >Since your hardware-control application/shared object does not have to be matched against the Linux kernel version number, you may distribute it as a binary object (to protect your code from unauthorized copying). If you select to distribute your driver's source code, note that under the license agreement with Jungo you may not distribute the source code of the <code>libwdapi1511.so</code> shared object, or the WinDriver license string used in your code.</p>
<h2><a class="anchor" id="ch15_3_2_building_and_installing_the_windriver_driver_module_on_the_target"></a>
15.3.2. Building and Installing the WinDriver Driver Module on the Target</h2>
<p >From the distribution package subdirectory containing the configure script and related build and installation files — normally the redist subdirectory — perform the following steps to build and install the driver module on the target:</p>
<ul>
<li>Generate the required makefiles:</li>
</ul>
<div class="fragment"><div class="line"># for PCI run:</div>
<div class="line">$ ./configure --disable-usb-support</div>
<div class="line"> </div>
<div class="line"># for USB run:</div>
<div class="line">$ ./configure</div>
</div><!-- fragment --><p >The configuration script creates a makefile based on the running kernel. You may select to use another installed kernel source, by executing the script with the <code>--with-kernel-source=&lt;path&gt;</code> option, where <code>&lt;path&gt;</code>is the full path to the kernel source directory — e.g., <code>/usr/src/linux</code>.</p>
<p >If the Linux kernel version is 2.6.26 or higher, the configuration script generates makefiles that use kbuild to compile the kernel modules. You can force the use of kbuild on earlier versions of Linux, by executing the configuration script with the <code>--enable-kbuild</code> flag.</p>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;For a full list of the configuration script options, use the &ndash;help option: <code>./configure --help</code>. </p>
</blockquote>
</blockquote>
<ul>
<li>Build the WinDriver driver module:</li>
</ul>
<div class="fragment"><div class="line">$ make</div>
</div><!-- fragment --><p >This will create a <code>LINUX.&lt;kernel version&gt;.&lt;CPU&gt;</code> directory, containing the newly compiled driver module — <code>windrvr1511.o/.ko</code>.</p>
<ul>
<li>Install the <code>windrvr1511.o/.ko</code> driver module.</li>
</ul>
<p >The following command must be executed with root privileges.</p>
<div class="fragment"><div class="line"># make install</div>
</div><!-- fragment --><p >The installation is performed using the setup_inst_dir script, which copies the driver module to the target's loadable kernel modules directory, and uses the wdreg script to load the driver module.</p>
<ul>
<li>Change the user and group IDs and give read/write permissions to the device file <code>/dev/windrvr1511</code>, depending on how you wish to allow users to access hardware through the device.</li>
</ul>
<p >Due to security reasons, by default the device file is created with permissions only for the root user. Change the permissions by modifying your <code>/etc/udev/permissions.d/50-udev.permissions</code> file. For example, add the following line to provide read and write permissions:</p>
<div class="fragment"><div class="line">`windrvr1511:root:root:0666`</div>
</div><!-- fragment --><p >Use the wdreg script to dynamically load the WinDriver driver module on the target after each boot. To automate this, copy wdreg to the target machine, and add the following line to the target's Linux boot file (for example, <code>/etc/rc.local</code>):</p>
<div class="fragment"><div class="line">&lt;path to wdreg&gt; windrvr1511</div>
</div><!-- fragment --><h2><a class="anchor" id="ch15_3_3_building_and_installing_your_kernel_plugin_driver_on_the_target"></a>
15.3.3. Building and Installing Your Kernel PlugIn Driver on the Target</h2>
<p >If you have created a Kernel PlugIn driver [11], build and install this driver — kp_xxx_module.o/.ko — on the target, by performing the following steps from the distribution package subdirectory containing the configure.kp script and related build and installation files — normally the redist subdirectory.</p>
<ul>
<li>Generate the Kernel PlugIn makefile — <code>makefile.kp</code>:</li>
</ul>
<div class="fragment"><div class="line">$ ./configure.kp</div>
</div><!-- fragment --><p >The configuration script creates a makefile based on the running kernel. You may select to use another installed kernel source, by executing the script with the <code>--with-kernel-source=&lt;path&gt;</code> option, where <code>&lt;path&gt;</code>is the full path to the kernel source directory — e.g., <code>/usr/src/linux</code>.</p>
<p >If the Linux kernel version is 2.6.26 or higher, the configuration script generates makefiles that use kbuild to compile the kernel modules. You can force the use of kbuild on earlier versions of Linux, by executing the configuration script with the <code>--enable-kbuild flag</code>.</p>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;For a full list of the configuration script options, use the &ndash;help option: <code>./configure --help</code>. </p>
</blockquote>
</blockquote>
<ul>
<li>Build the Kernel PlugIn driver module: <div class="fragment"><div class="line">$ make -f makefile.kp</div>
</div><!-- fragment --></li>
</ul>
<p >This will create a <code>LINUX.&lt;kernel version&gt;.&lt;CPU&gt;.KP</code> directory, containing the newly compiled driver module — <code>kp_xxx_module.o/.ko</code>.</p>
<ul>
<li>Install the Kernel PlugIn module.</li>
</ul>
<p >The following command must be executed with root privileges.</p>
<div class="fragment"><div class="line"># make install -f makefile.kp</div>
</div><!-- fragment --><p >To automatically load your Kernel PlugIn driver on each boot, add the following line to the target's Linux boot file (for example, <code>/etc/rc.local</code>), after the WinDriver driver module load command (replace <code>&lt;path to kp_xxx_module.o/.ko&gt;</code> with the path to your Kernel PlugIn driver module, which is found in your <code>LINUX.&lt;kernel version&gt;.&lt;CPU&gt;.KP</code> distribution directory):</p>
<div class="fragment"><div class="line">`/sbin/insmod &lt;path to kp_xxx_module.o/.ko&gt;`</div>
</div><!-- fragment --><h2><a class="anchor" id="ch15_3_4_installing_the_user-mode_hardware-control_application_or_shared_object"></a>
15.3.4. Installing the User-Mode Hardware-Control Application or Shared Object</h2>
<p >If your user-mode hardware-control application or shared object uses <code>libwdapi1511.so</code> (and <code>libwdapi_java1511.so</code> if it is a Java application), copy it (them) from the distribution package to the target's library directory:</p>
<ul>
<li><code>/usr/lib</code> — when distributing a 32-bit application/shared object to a 32-bit or 64-bit target.</li>
<li><code>/usr/lib64</code> — when distributing a 64-bit application/shared object to a 64-bit target.</li>
</ul>
<p >If you decided to distribute the source code of the application/shared object, copy the source code to the target as well.</p>
<blockquote class="doxtable">
<p >&zwj;<b>⚠ Attention</b></p>
<blockquote class="doxtable">
<p >&zwj;Remember that you may not distribute the source code of the <code>libwdapi1511.so</code> shared object or your WinDriver license string as part of the source code distribution. </p>
</blockquote>
</blockquote>
<h2><a class="anchor" id="ch15_3_5_redistribute_your_windriver-based_package_as_a_self-extracting_sh_stgz"></a>
15.3.5. Redistribute Your WinDriver-based package as a self-extracting SH (STGZ)</h2>
<p >Starting from WinDriver version 14.6, WinDriver supports creation of self extracting installers for Linux for your generated code and user applications, via a CMake Project.</p>
<h3><a class="anchor" id="ch15_3_5_1_the_installer_linux"></a>
15.3.5.1. The Installer</h3>
<p >What the Installer does:</p>
<ul>
<li>Packs your driver and your user application into a single self-extracting SH file.</li>
<li>Installs the user application files to the target computer.</li>
<li>Installs WinDriver to the target computer running <code>configure</code> and <code>make install</code>.</li>
<li>Provides the user with an uninstall SH script that removes the user application and the driver from the target computer.</li>
</ul>
<p >This allows to save users precious time in manually creating a redistribution package.</p>
<h3><a class="anchor" id="ch15_3_5_2_requirements_linux"></a>
15.3.5.2. Requirements</h3>
<p >Please make sure CMake version 3.17 or higher is installed on the development computer.</p>
<h3><a class="anchor" id="ch15_3_5_3_instructions_linux"></a>
15.3.5.3. Instructions</h3>
<p >Please follow these steps:</p>
<ul>
<li>From the DriverWizard code generation window – check the CMake Makefile Checkbox.</li>
</ul>
<p ><b>WinDriver Code Generation Window</b></p>
<div class="image">
<img src="cmake4.png" alt=""/>
</div>
 <ul>
<li>In your generated code directory for your driver (<code>xxx</code> will be the driver name in this tutorial) found in <code>WinDriver\wizard\my_projects\xxx</code> you should find a <code>CMakeLists.txt</code> file.</li>
</ul>
<div class="fragment"><div class="line">$ cd WinDriver\wizard\my_projects\xxx</div>
<div class="line">$ cmake . -B build</div>
</div><!-- fragment --><ul>
<li>In order to redistribute your driver – edit <code>xxx_lib.c</code> such that <code>XXX_DEFAULT_LICENSE_STRING</code> will be defined to be your license string, and that <code>XXX_DEFAULT_DRIVER_NAME</code> will be defined to be your renamed driver name (in this case <code>xxx</code>). If you do not perform this step your user application might work on your development computer but will not work on the target computer.</li>
<li>Build the project <div class="fragment"><div class="line">$ cd build</div>
<div class="line">$ make pacakge</div>
</div><!-- fragment --></li>
</ul>
<p >You should find in your user application binary <code>WinDriver\wizard\my_projects\xxx\build</code> and an additional installer SH file <code>xxx_1.0.0-Linux.sh</code> in <code>WinDriver\wizard\my_projects\xxx\build</code>. <br  />
 Jungo recommends using the installer SH file for distributing your driver package.</p><ul>
<li>Feel free to modify the <code>CMakeLists.txt</code> file to better suit for your needs. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
